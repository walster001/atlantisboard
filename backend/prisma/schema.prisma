// Prisma schema for AtlantisBoard
// Migrated from Supabase PostgreSQL schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum BoardRole {
  admin
  manager
  viewer
}

// Permission keys use String type since they contain dots (e.g., 'app.admin.access')
// Validation happens in application layer

// Users table (replaces Supabase auth.users)
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  passwordHash  String?   // Null for OAuth users
  provider      String?   // 'email', 'google', etc.
  providerId    String?   // OAuth provider user ID
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  profile       Profile?
  refreshTokens RefreshToken[]
  createdWorkspaces Workspace[] @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
  boardMemberships BoardMember[]
  createdBoards Board[] @relation("BoardCreator")
  createdCards  Card[] @relation("CardCreator")
  assignedCards CardAssignee[] @relation("CardAssignee")
  assignedBy    CardAssignee[] @relation("CardAssigner")
  completedSubtasks CardSubtask[] @relation("SubtaskCompleter")
  uploadedAttachments CardAttachment[]
  createdThemes BoardTheme[]
  createdRoles  CustomRole[]
  createdInviteTokens BoardInviteToken[] @relation("InviteTokenCreator")
  usedInviteTokens BoardInviteToken[] @relation("InviteTokenUser")
  auditLogActions BoardMemberAuditLog[] @relation("AuditLogActor")
  resolvedImportAssignees ImportPendingAssignee[] @relation("ImportAssigneeResolver")
  resolvedImportAttachments ImportPendingAttachment[] @relation("ImportAttachmentResolver")
  boardMemberCustomRoles BoardMemberCustomRole[]

  @@index([email])
  @@map("users")
}

// Refresh tokens for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// User profiles (extends users)
model Profile {
  id        String   @id @default(uuid())
  email     String
  fullName  String?  @map("full_name")
  avatarUrl String?  @map("avatar_url")
  isAdmin   Boolean  @default(false) @map("is_admin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [id], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// Application settings
model AppSettings {
  id                                 String   @id @default("default")
  customLoginLogoEnabled             Boolean  @default(false) @map("custom_login_logo_enabled")
  customLoginLogoUrl                String?  @map("custom_login_logo_url")
  customLoginLogoSize               String   @default("medium") @map("custom_login_logo_size")
  customHomeLogoEnabled             Boolean  @default(false) @map("custom_home_logo_enabled")
  customHomeLogoUrl                 String?  @map("custom_home_logo_url")
  customHomeLogoSize                Int      @default(40) @map("custom_home_logo_size")
  customBoardLogoEnabled            Boolean  @default(false) @map("custom_board_logo_enabled")
  customBoardLogoUrl                String?  @map("custom_board_logo_url")
  customBoardLogoSize               Int      @default(40) @map("custom_board_logo_size")
  customAppNameEnabled              Boolean  @default(false) @map("custom_app_name_enabled")
  customAppName                     String?  @map("custom_app_name")
  customAppNameSize                 Int      @default(24) @map("custom_app_name_size")
  customAppNameColor                String   @default("#000000") @map("custom_app_name_color")
  customAppNameFont                 String?  @default("default") @map("custom_app_name_font")
  customGlobalAppNameEnabled        Boolean  @default(false) @map("custom_global_app_name_enabled")
  customGlobalAppName               String?  @map("custom_global_app_name")
  customTaglineEnabled              Boolean  @default(false) @map("custom_tagline_enabled")
  customTagline                     String?  @map("custom_tagline")
  customTaglineSize                 Int      @default(14) @map("custom_tagline_size")
  customTaglineColor                String   @default("#6b7280") @map("custom_tagline_color")
  customTaglineFont                 String?  @default("default") @map("custom_tagline_font")
  customLoginBackgroundEnabled      Boolean  @default(false) @map("custom_login_background_enabled")
  customLoginBackgroundType         String   @default("color") @map("custom_login_background_type")
  customLoginBackgroundColor       String   @default("#f3f4f6") @map("custom_login_background_color")
  customLoginBackgroundImageUrl     String?  @map("custom_login_background_image_url")
  customLoginBoxBackgroundColor    String   @default("#ffffff") @map("custom_login_box_background_color")
  customGoogleButtonBackgroundColor String  @default("#ffffff") @map("custom_google_button_background_color")
  customGoogleButtonTextColor       String  @default("#000000") @map("custom_google_button_text_color")
  loginStyle                       String   @default("google_only") @map("login_style")
  auditLogRetentionDays            Int?     @map("audit_log_retention_days")
  createdAt                        DateTime @default(now()) @map("created_at")
  updatedAt                        DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}

// Custom fonts
model CustomFont {
  id       String   @id @default(uuid())
  name     String
  fontUrl  String   @map("font_url")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("custom_fonts")
}

// Board themes
model BoardTheme {
  id                              String   @id @default(uuid())
  name                            String
  navbarColor                     String   @default("#0079bf") @map("navbar_color")
  columnColor                     String   @default("#ffffff") @map("column_color")
  boardIconColor                  String   @default("#ffffff") @map("board_icon_color")
  homepageBoardColor              String   @default("#0079bf") @map("homepage_board_color")
  scrollbarColor                  String   @default("#888888") @map("scrollbar_color")
  scrollbarTrackColor             String   @default("#f1f1f1") @map("scrollbar_track_color")
  cardWindowColor                 String   @default("#ffffff") @map("card_window_color")
  cardWindowTextColor             String   @default("#000000") @map("card_window_text_color")
  cardWindowButtonColor           String   @default("#0079bf") @map("card_window_button_color")
  cardWindowButtonTextColor       String   @default("#ffffff") @map("card_window_button_text_color")
  cardWindowButtonHoverColor      String?  @map("card_window_button_hover_color")
  cardWindowButtonHoverTextColor  String?  @map("card_window_button_hover_text_color")
  cardWindowIntelligentContrast   Boolean  @default(false) @map("card_window_intelligent_contrast")
  defaultCardColor                String?  @map("default_card_color")
  isDefault                        Boolean  @default(false) @map("is_default")
  createdBy                       String?  @map("created_by")
  createdAt                       DateTime @default(now()) @map("created_at")
  updatedAt                       DateTime @updatedAt @map("updated_at")

  creator                         User?    @relation("ThemeCreator", fields: [createdBy], references: [id])
  boards                          Board[]

  @@map("board_themes")
}

// Workspaces
model Workspace {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String   @map("owner_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  owner       User     @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members     WorkspaceMember[]
  boards      Board[]
  boardMemberCustomRoles BoardMemberCustomRole[]

  @@index([ownerId])
  @@map("workspaces")
}

// Workspace members
model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String  @map("workspace_id")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

// Boards
model Board {
  id                    String   @id @default(uuid())
  workspaceId           String   @map("workspace_id")
  name                  String
  description           String?
  backgroundColor       String?  @default("#0079bf") @map("background_color")
  themeId              String?  @map("theme_id")
  position              Int      @default(0)
  auditLogRetentionDays Int?      @map("audit_log_retention_days")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  workspace             Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  theme                 BoardTheme? @relation(fields: [themeId], references: [id], onDelete: SetNull)
  members               BoardMember[]
  columns               Column[]
  labels                Label[]
  inviteTokens          BoardInviteToken[]
  auditLogs             BoardMemberAuditLog[]
  importPendingAssignees ImportPendingAssignee[]
  importPendingAttachments ImportPendingAttachment[]

  @@index([workspaceId])
  @@map("boards")
}

// Board members
model BoardMember {
  id        String    @id @default(uuid())
  boardId   String    @map("board_id")
  userId    String    @map("user_id")
  role      BoardRole @default(viewer)
  createdAt DateTime  @default(now()) @map("created_at")

  board     Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  customRoles BoardMemberCustomRole[]

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
  @@map("board_members")
}

// Board member audit log
model BoardMemberAuditLog {
  id           String   @id @default(uuid())
  boardId      String   @map("board_id")
  action       String
  targetUserId String   @map("target_user_id")
  actorUserId  String?  @map("actor_user_id")
  oldRole      String?  @map("old_role")
  newRole      String?  @map("new_role")
  createdAt    DateTime @default(now()) @map("created_at")

  board        Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  actor        User?     @relation("AuditLogActor", fields: [actorUserId], references: [id])

  @@index([boardId])
  @@map("board_member_audit_log")
}

// Board invite tokens
model BoardInviteToken {
  id        String    @id @default(uuid())
  boardId   String    @map("board_id")
  token     String    @unique
  linkType  String    @default("one_time") @map("link_type")
  createdBy String    @map("created_by")
  expiresAt DateTime?  @map("expires_at")
  usedAt    DateTime?  @map("used_at")
  usedBy    String?    @map("used_by")
  createdAt DateTime  @default(now()) @map("created_at")

  board     Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  creator   User      @relation("InviteTokenCreator", fields: [createdBy], references: [id])
  user      User?     @relation("InviteTokenUser", fields: [usedBy], references: [id])

  @@index([token])
  @@map("board_invite_tokens")
}

// Custom roles
model CustomRole {
  id          String   @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  creator     User?    @relation(fields: [createdBy], references: [id])
  permissions RolePermission[]
  boardMemberAssignments BoardMemberCustomRole[]

  @@map("custom_roles")
}

// Role permissions
model RolePermission {
  id            String   @id @default(uuid())
  roleId        String?  @map("role_id")
  permissionKey String   @map("permission_key") // Uses String to support dots (e.g., 'app.admin.access')
  createdAt     DateTime @default(now()) @map("created_at")

  role          CustomRole? @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionKey])
  @@index([roleId])
  @@map("role_permissions")
}

// Board member custom roles
model BoardMemberCustomRole {
  id          String   @id @default(uuid())
  boardId     String   @map("board_id")
  userId      String   @map("user_id")
  customRoleId String  @map("custom_role_id")
  createdAt   DateTime @default(now()) @map("created_at")

  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        CustomRole  @relation(fields: [customRoleId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId, customRoleId])
  @@index([boardId])
  @@index([userId])
  @@map("board_member_custom_roles")
}

// Columns
model Column {
  id        String   @id @default(uuid())
  boardId   String   @map("board_id")
  title     String
  position  Int      @default(0)
  color     String?
  createdAt DateTime @default(now()) @map("created_at")

  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards     Card[]

  @@index([boardId])
  @@map("columns")
}

// Cards
model Card {
  id          String    @id @default(uuid())
  columnId    String    @map("column_id")
  title       String
  description String?
  position    Int       @default(0)
  color       String?
  priority    String?   @default("none")
  dueDate     DateTime? @map("due_date")
  createdBy   String?   @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  column      Column    @relation(fields: [columnId], references: [id], onDelete: Cascade)
  creator     User?     @relation("CardCreator", fields: [createdBy], references: [id])
  assignees   CardAssignee[]
  subtasks    CardSubtask[]
  attachments CardAttachment[]
  labels      CardLabel[]

  @@index([columnId])
  @@map("cards")
}

// Card assignees
model CardAssignee {
  id         String   @id @default(uuid())
  cardId     String   @map("card_id")
  userId     String   @map("user_id")
  assignedBy String?   @map("assigned_by")
  assignedAt DateTime @default(now()) @map("assigned_at")

  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user       User     @relation("CardAssignee", fields: [userId], references: [id])
  assigner   User?    @relation("CardAssigner", fields: [assignedBy], references: [id])

  @@unique([cardId, userId])
  @@index([cardId])
  @@map("card_assignees")
}

// Card subtasks
model CardSubtask {
  id            String    @id @default(uuid())
  cardId        String    @map("card_id")
  title         String
  completed     Boolean   @default(false)
  completedAt   DateTime? @map("completed_at")
  completedBy   String?   @map("completed_by")
  position      Int       @default(0)
  checklistName String?   @default("Checklist") @map("checklist_name")
  createdAt     DateTime  @default(now()) @map("created_at")

  card          Card      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  completer     User?     @relation("SubtaskCompleter", fields: [completedBy], references: [id])

  @@index([cardId])
  @@map("card_subtasks")
}

// Card attachments
model CardAttachment {
  id         String   @id @default(uuid())
  cardId     String   @map("card_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileType   String?  @map("file_type")
  fileSize   Int?     @map("file_size")
  uploadedBy String?  @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")

  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  uploader   User?    @relation(fields: [uploadedBy], references: [id])

  @@index([cardId])
  @@map("card_attachments")
}

// Labels
model Label {
  id      String  @id @default(uuid())
  boardId String  @map("board_id")
  name    String
  color   String

  board   Board   @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards   CardLabel[]

  @@index([boardId])
  @@map("labels")
}

// Card labels (many-to-many)
model CardLabel {
  cardId  String @map("card_id")
  labelId String @map("label_id")

  card    Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([cardId, labelId])
  @@index([cardId])
  @@index([labelId])
  @@map("card_labels")
}

// Import pending assignees
model ImportPendingAssignee {
  id                String   @id @default(uuid())
  boardId           String   @map("board_id")
  cardId            String   @map("card_id")
  originalMemberName String  @map("original_member_name")
  originalMemberId  String?  @map("original_member_id")
  originalUsername  String?  @map("original_username")
  mappedUserId      String?  @map("mapped_user_id")
  importSource      String   @default("unknown") @map("import_source")
  resolvedAt        DateTime? @map("resolved_at")
  resolvedBy        String?  @map("resolved_by")
  createdAt         DateTime @default(now()) @map("created_at")

  board             Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  resolver          User?    @relation("ImportAssigneeResolver", fields: [resolvedBy], references: [id])

  @@index([boardId])
  @@index([cardId])
  @@map("import_pending_assignees")
}

// Import pending attachments
model ImportPendingAttachment {
  id              String   @id @default(uuid())
  boardId         String   @map("board_id")
  cardId          String   @map("card_id")
  originalName    String   @map("original_name")
  originalUrl     String?  @map("original_url")
  originalType    String?  @map("original_type")
  originalSize    Int?     @map("original_size")
  originalAttachmentId String? @map("original_attachment_id")
  uploadedFileUrl String?  @map("uploaded_file_url")
  importSource    String   @default("unknown") @map("import_source")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?  @map("resolved_by")
  createdAt       DateTime @default(now()) @map("created_at")

  board           Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  resolver        User?    @relation("ImportAttachmentResolver", fields: [resolvedBy], references: [id])

  @@index([boardId])
  @@index([cardId])
  @@map("import_pending_attachments")
}

// MySQL configuration
model MysqlConfig {
  id                    String   @id @default("default")
  dbHostEncrypted       String?  @map("db_host_encrypted")
  dbNameEncrypted       String?  @map("db_name_encrypted")
  dbUserEncrypted       String?  @map("db_user_encrypted")
  dbPasswordEncrypted   String?  @map("db_password_encrypted")
  iv                    String?
  verificationQuery     String?  @default("SELECT 1 FROM users WHERE email = ? LIMIT 1") @map("verification_query")
  isConfigured          Boolean?  @default(false) @map("is_configured")
  createdAt             DateTime? @default(now()) @map("created_at")
  updatedAt             DateTime? @updatedAt @map("updated_at")

  @@map("mysql_config")
}

